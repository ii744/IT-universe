<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—Ä—ñ–π (–î–µ–º–æ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Comfortaa', cursive;
            background-color: #121212;
            color: #E0E0E0;
            overflow-x: hidden;
        }
        .logo {
            font-family: 'Marck Script', cursive;
            font-size: 3rem;
            color: #FFFFFF;
        }
        .handwritten {
            font-family: 'Comfortaa', cursive;
        }
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            min-height: 100vh;
            width: 100%;
        }
        .screen.active {
            display: flex;
            opacity: 1;
        }
        /* Typing cursor */
        .typing-text span {
            border-right: .1em solid white;
            animation: caret 1s steps(1) infinite;
        }
        @keyframes caret { 50% { border-color: transparent; } }

        /* Chat styles */
        .message { max-width: 85%; }
        .user-message { background-color: #3B82F6; color: white; align-self: flex-end;}
        .ai-message { background-color: #374151; color: white; align-self: flex-start;}
        .system-message { align-self: center; color: #9CA3AF; font-style: italic; font-size: 0.875rem;}
        #message-container { display: flex; flex-direction: column; gap: 0.75rem; }
        
        /* Loading spinner */
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π input file */
        #file-upload { display: none; }
    </style>
</head>
<body class="bg-black text-white">

    <div id="intro-screen" class="screen active flex-col justify-center items-center text-center p-4">
        <header class="absolute top-8">
            <h1 class="logo">–û–±—Ä—ñ–π*</h1>
        </header>
        <main class="flex flex-col items-center justify-center h-full">
            <p class="handwritten text-2xl md:text-4xl mb-12">–°—å–æ–≥–æ–¥–Ω—ñ —è —Ö–æ—á—É <span id="typing-effect" class="font-bold"></span></p>
            <button id="start-btn" class="handwritten bg-white text-black font-bold py-3 px-8 rounded-lg text-xl hover:bg-gray-200 transition-colors">–†–æ–∑–ø–æ—á–∞—Ç–∏</button>
        </main>
    </div>

    <div id="tone-screen" class="screen flex-col justify-center items-center text-center p-4">
        <header class="absolute top-8"><h1 class="logo">–û–±—Ä—ñ–π*</h1></header>
        <main class="flex flex-col items-center">
            <h2 class="handwritten text-2xl md:text-3xl mb-8">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–Ω —Ä–æ–∑–º–æ–≤–∏</h2>
            <div class="border-2 border-zinc-600 rounded-2xl w-full max-w-xs sm:max-w-sm p-6 sm:p-8 flex flex-col items-center">
                <div class="flex items-center justify-between w-full">
                    <button id="prev-tone" class="text-4xl text-zinc-400 hover:text-white transition-colors">&lt;</button>
                    <div id="tone-display" class="flex flex-col items-center text-center">
                        <div id="tone-emoji" class="text-7xl sm:text-8xl mb-4"></div>
                        <h3 id="tone-name" class="font-bold text-2xl sm:text-3xl mb-2"></h3>
                    </div>
                    <button id="next-tone" class="text-4xl text-zinc-400 hover:text-white transition-colors">&gt;</button>
                </div>
                <div class="flex justify-center mt-4 space-x-2" id="tone-dots"></div>
                <p id="tone-description" class="text-zinc-400 mt-6 text-base sm:text-lg h-12"></p>
            </div>
            <button id="continue-btn" class="handwritten mt-8 bg-white text-black font-bold py-3 px-8 rounded-lg text-xl hover:bg-gray-200 transition-colors">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        </main>
    </div>

    <div id="main-screen" class="screen flex-col items-center p-4 sm:p-8">
        <main class="w-full max-w-4xl mx-auto">
            <h2 class="handwritten text-3xl md:text-4xl text-center my-8">–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º, –°–∞—à–∫–æ!</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-start gap-4 sm:gap-8 bg-zinc-900/50 p-6 rounded-2xl mb-12">
                <img src="https://i.imgur.com/8Q1mC6H.png" alt="User Avatar" class="w-24 h-24 rounded-full border-2 border-zinc-700"> <div class="w-full text-center sm:text-left">
                    <p class="text-xl font-bold">–õ–µ–≤–µ–ª 2. –ó—ñ—Ä–æ–Ω—å–∫–∞</p>
                    <div class="w-full bg-zinc-700 rounded-full h-2.5 mt-2"><div class="bg-white h-2.5 rounded-full" style="width: 50%"></div></div>
                    <p class="text-zinc-400 text-sm mt-1">50 / 100 XP</p>
                </div>
            </div>
            
            <h3 class="handwritten text-2xl md:text-3xl text-center mb-8">–û–±–µ—Ä—ñ—Ç—å –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div id="university-chat-btn" class="flex flex-col items-center justify-center text-center p-6 border-2 border-zinc-700 rounded-2xl h-64 hover:bg-zinc-800 hover:border-white transition-all cursor-pointer">
                    <div class="text-4xl mb-4">üèõÔ∏è</div>
                    <p class="text-xl font-bold">–ü–∏—Ç–∞–Ω–Ω—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É</p>
                    <p class="text-zinc-400 mt-2">–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –ø—Ä–æ –≤—Å—Ç—É–ø, —Å—Ç–∏–ø–µ–Ω–¥—ñ—ó —Ç–∞ –ø—Ä–∞–≤–∏–ª–∞</p>
                </div>
                
                <div id="tutor-chat-btn" class="flex flex-col items-center justify-center text-center p-6 border-2 border-zinc-700 rounded-2xl h-64 hover:bg-zinc-800 hover:border-white transition-all cursor-pointer">
                    <div class="text-4xl mb-4">üßë‚Äçüè´</div>
                    <p class="text-xl font-bold">–î–æ–ø–æ–º–æ–≥–∞ –∑ –Ω–∞–≤—á–∞–Ω–Ω—è–º</p>
                    <p class="text-zinc-400 mt-2">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ª–µ–∫—Ü—ñ—é –∞–±–æ —Ç–µ–º—É —ñ –ø–æ—á–Ω—ñ—Ç—å –≤—á–∏—Ç–∏—Å—è</p>
                </div>

            </div>
        </main>
    </div>
    
    <div id="chat-screen" class="screen flex-col h-screen p-4 max-w-3xl mx-auto w-full">
        <header class="text-center mb-4 flex items-center justify-between">
            <button id="back-to-main-btn" class="handwritten text-zinc-400 hover:text-white transition-colors">&lt; –ù–∞–∑–∞–¥</button>
            <h1 class="logo -mb-4">–û–±—Ä—ñ–π*</h1>
            <div class="w-16"></div> </header>
        
        <div id="message-container" class="flex-grow overflow-y-auto p-4 space-y-3">
             </div>
        
        <form id="chat-form" class="mt-4 flex gap-2 items-center">
            
            <label id="file-upload-label" for="file-upload" class="hidden bg-gray-600 text-white rounded-full p-3 h-12 w-12 flex items-center justify-center cursor-pointer hover:bg-gray-500 transition-colors">
                <span class="text-2xl">üìé</span>
            </label>
            <input type="file" id="file-upload" accept=".txt"> <input type="text" id="message-input" class="flex-grow bg-gray-700 rounded-full px-5 py-3 h-12 focus:outline-none placeholder-zinc-400" placeholder="–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
            <button type="submit" class="bg-blue-600 text-white rounded-full h-12 w-12 flex items-center justify-center font-bold hover:bg-blue-500 transition-colors">
                <span class="text-2xl">‚û§</span>
            </button>
        </form>
        <p class="text-xs text-zinc-500 text-center mt-2 px-4">
            –Ø–∫—â–æ –≤–∏ —Ä–æ–∑—ñ–±—Ä–∞–ª–∏ —Ç–µ–º—É, —Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Å—Ç–æ–ø —Å–ª–æ–≤–æ "–°–¢–û–ü".
        </p>

    </div>

    <div id="test-modal" class="modal-overlay"> ... </div>
    <div id="flashcard-modal" class="modal-overlay"> ... </div>

    <script>
        // --- –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –ö–ª—é—á API —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –î–µ–º–æ ---
        
        // üõë –í–ê–ñ–õ–ò–í–û! –í—Å—Ç–∞–≤ —Å—é–¥–∏ —Å–≤—ñ–π API-–∫–ª—é—á –∑ Google AI Studio
        const API_KEY = 'AIzaSyAdKDUTFo3fkzRXSLYnz3oYDYUjg_JLAJI'; 
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025'; // –Ø–∫ —Ç–∏ —ñ –ø—Ä–æ—Å–∏–≤
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        // üõë –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è "—Å–∏–º—É–ª—è—Ü—ñ—ó" –î–µ–º–æ –≤ –ß–∞—Ç 1 (–Æ—Ä–∏—Å—Ç)
        // –¢–∏ –º–æ–∂–µ—à –∑–º—ñ–Ω–∏—Ç–∏ —Ü–µ–π —Ç–µ–∫—Å—Ç, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞ –¥–µ–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–æ –Ω—å–æ–º—É
        const FAKE_DOC_NAME = '9.–ü–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ —Å–∫–ª–∞–¥—É –∑–¥–æ–±—É–≤–∞—á –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏.pdf';
        const FAKE_DOC_CONTENT = `
            9.1. –ü–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –Ω–∞–≤—á–∞–Ω–Ω—è –∑–¥–æ–±—É–≤–∞—á—ñ–≤ –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è, —è–∫
            –ø—Ä–∞–≤–∏–ª–æ, –ø—ñ–¥ —á–∞—Å –∫–∞–Ω—ñ–∫—É–ª –≤ –º–µ–∂–∞—Ö –ª—ñ—Ü–µ–Ω–∑–æ–≤–∞–Ω–æ–≥–æ –æ–±—Å—è–≥—É.
            9.2. –ü–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ —Å–∫–ª–∞–¥—É –∑–¥–æ–±—É–≤–∞—á—ñ–≤ –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏ –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è —Ä–µ–∫—Ç–æ—Ä–æ–º –Ω–∞
            –ø—ñ–¥—Å—Ç–∞–≤—ñ –∑–∞—è–≤–∏, –æ—Å–æ–±–∏—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ—ó –∑–¥–æ–±—É–≤–∞—á–µ–º –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏ –∑–∞ –∑—Ä–∞–∑–∫–æ–º (–¥–∏–≤.
            –¥–æ–¥–∞—Ç–æ–∫ –ù), –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –ø—Ä–∏—á–∏–Ω–∏ –≤—ñ–¥—Ä–∞—Ö—É–≤–∞–Ω–Ω—è, —Ç—Ä—É–¥–æ–≤–æ–≥–æ —Å—Ç–∞–∂—É, —Ñ–æ—Ä–º–∏
            –Ω–∞–≤—á–∞–Ω–Ω—è —ñ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∑–¥–∞—Ç–Ω–æ—Å—Ç—ñ –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫
            –æ—Å–≤—ñ—Ç–Ω—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É. –î–æ –∑–∞—è–≤–∏ –¥–æ–¥–∞—î—Ç—å—Å—è –≤–∏—Ç—è–≥ –∑ –Ω–∞–∫–∞–∑—É –ø—Ä–æ –≤—ñ–¥—Ä–∞—Ö—É–≤–∞–Ω–Ω—è.
            9.3. –ü—Ä–∏ –ø–æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –Ω–∞ –Ω–∞–≤—á–∞–Ω–Ω—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –∞–∫–∞–¥–µ–º—ñ—á–Ω—É —Ä—ñ–∑–Ω–∏—Ü—é
            –º—ñ–∂ –Ω–∞–≤—á–∞–ª—å–Ω–∏–º–∏ –ø–ª–∞–Ω–∞–º–∏ —Ñ–∞—Ö–æ–≤–æ—ó –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏.
            9.4. –ü–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–¥–æ–±—É–≤–∞—á—ñ–≤ –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏ –Ω–∞ –ø–µ—Ä—à–∏–π –∫—É—Ä—Å –∑–∞–±–æ—Ä–æ–Ω—è—î—Ç—å—Å—è. –†–µ–∫—Ç–æ—Ä
            –º–∞—î –ø—Ä–∞–≤–æ, —è–∫ –≤–∏–Ω—è—Ç–æ–∫, –ø–æ–Ω–æ–≤–∏—Ç–∏ –Ω–∞ –¥—Ä—É–≥–∏–π –∫—É—Ä—Å –∑–¥–æ–±—É–≤–∞—á—ñ–≤ –≤–∏—â–æ—ó –æ—Å–≤—ñ—Ç–∏, —è–∫—ñ –±—É–ª–∏
            –≤—ñ–¥—Ä–∞—Ö–æ–≤–∞–Ω—ñ –∑ –ø–µ—Ä—à–æ–≥–æ –∫—É—Ä—Å—É, –∑–∞ —É–º–æ–≤–∏ –ª—ñ–∫–≤—ñ–¥–∞—Ü—ñ—ó –Ω–∏–º–∏ –∞–∫–∞–¥–µ–º—ñ—á–Ω–æ—ó —Ä—ñ–∑–Ω–∏—Ü—ñ –¥–æ –ø–æ—á–∞—Ç–∫—É
            –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ —Ä–æ–∫—É, –∞–±–æ —Å–µ–º–µ—Å—Ç—Ä—É.
        `;
        
        // --- DOM Elements ---
        const introScreen = document.getElementById('intro-screen'), 
              toneScreen = document.getElementById('tone-screen'), 
              mainScreen = document.getElementById('main-screen'), 
              chatScreen = document.getElementById('chat-screen');
        const startBtn = document.getElementById('start-btn'), 
              continueBtn = document.getElementById('continue-btn');
        const typingElement = document.getElementById('typing-effect');
        const prevToneBtn = document.getElementById('prev-tone'), 
              nextToneBtn = document.getElementById('next-tone');
        const toneEmoji = document.getElementById('tone-emoji'), 
              toneName = document.getElementById('tone-name'), 
              toneDescription = document.getElementById('tone-description'), 
              toneDotsContainer = document.getElementById('tone-dots');
        
        // --- –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –ù–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ DOM ---
        const universityChatBtn = document.getElementById('university-chat-btn');
        const tutorChatBtn = document.getElementById('tutor-chat-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const messageContainer = document.getElementById('message-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const fileUpload = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');

        // --- –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –¥–ª—è —á–∞—Ç—É ---
        let currentChatMode = null; // 'university' or 'tutor'
        let chatHistory = [];
        let uploadedFileContent = null; // –¢—É—Ç –±—É–¥–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –≤–º—ñ—Å—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É

        // --- Screen Logic ---
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }
        startBtn.addEventListener('click', () => showScreen(toneScreen));
        continueBtn.addEventListener('click', () => showScreen(mainScreen));
        
        // --- –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –ù–æ–≤—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–∞—Ç—É ---
        universityChatBtn.addEventListener('click', () => {
            currentChatMode = 'university';
            resetChat();
            fileUploadLabel.classList.add('hidden'); // –•–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            addMessage('üèõÔ∏è –í–∏ —É —á–∞—Ç—ñ –∑ "–ê—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É". –Ø–∫—ñ —É –≤–∞—Å –ø–∏—Ç–∞–Ω–Ω—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö?', 'system');
            showScreen(chatScreen);
        });

        tutorChatBtn.addEventListener('click', () => {
            currentChatMode = 'tutor';
            resetChat();
            fileUploadLabel.classList.remove('hidden'); // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            addMessage('üßë‚Äçüè´ –í–∏ —É —á–∞—Ç—ñ –∑ "–†–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–º". –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª (.txt) –∑ –ª–µ–∫—Ü—ñ—î—é –∞–±–æ –ø—Ä–æ—Å—Ç–æ –ø–æ—á–Ω—ñ—Ç—å –¥—ñ–∞–ª–æ–≥.', 'system');
            showScreen(chatScreen);
        });

        backToMainBtn.addEventListener('click', () => showScreen(mainScreen));
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è —á–∞—Ç—É
        function resetChat() {
            messageContainer.innerHTML = '';
            chatHistory = [];
            uploadedFileContent = null;
            fileUpload.value = null; // –°–∫–∏–¥–∞—î–º–æ input file
        }

        // --- Typing Effect (–ë–µ–∑ –∑–º—ñ–Ω) ---
        const phrases = ["—Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ –≤–∏—â—É –º–∞—Ç–µ–º–∞—Ç–∏–∫—É.", "–Ω–∞–≤—á–∏—Ç–∏—Å—è –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—é.", "–≤–∏–≤—á–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –º–∏—Å—Ç–µ—Ü—Ç–≤."];
        let phraseIndex = 0, charIndex = 0, isDeleting = false;
        function type() {
            if (!typingElement) return; // –ó–∞–ø–æ–±—ñ–∂–Ω–∏–∫, —è–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
            const currentPhrase = phrases[phraseIndex];
            let textToShow = '';

            if (isDeleting) {
                textToShow = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                textToShow = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            typingElement.textContent = textToShow;
            
            if (!typingElement.querySelector('span')) {
                const cursor = document.createElement('span');
                typingElement.appendChild(cursor);
            }

            let typeSpeed = isDeleting ? 75 : 150;
            if (!isDeleting && charIndex === currentPhrase.length) {
                typeSpeed = 2000; isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false; phraseIndex = (phraseIndex + 1) % phrases.length; typeSpeed = 500;
            }
            setTimeout(type, typeSpeed);
        }
        document.addEventListener('DOMContentLoaded', type);

        // --- Tone Selection (–ë–µ–∑ –∑–º—ñ–Ω) ---
        const tones = [{ name: '–ï–ª–ª–∞', emoji: 'ü™ê', description: '–ü—Ä–∏–≤—ñ—Ç–Ω–∞, –ø–æ—è—Å–Ω–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Å—Ç–æ.' }, { name: '–°–æ–∫—Ä–∞—Ç', emoji: 'üèõÔ∏è', description: '–ú—É–¥—Ä–∏–π, —Å—Ç–∞–≤–∏—Ç—å –Ω–∞–≤—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è.' }];
        let currentToneIndex = 0;
        function updateToneDisplay() {
            if(!toneEmoji) return; // –ó–∞–ø–æ–±—ñ–∂–Ω–∏–∫
            const tone = tones[currentToneIndex];
            toneEmoji.textContent = tone.emoji;
            toneName.textContent = tone.name;
            toneDescription.textContent = tone.description;
            updateDots();
        }
        function updateDots() {
            toneDotsContainer.innerHTML = '';
            tones.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.classList.add('h-2', 'w-2', 'rounded-full', 'transition-colors');
                dot.classList.toggle('bg-white', index === currentToneIndex);
                dot.classList.toggle('bg-zinc-600', index !== currentToneIndex);
                toneDotsContainer.appendChild(dot);
            });
        }
        prevToneBtn.addEventListener('click', () => { currentToneIndex = (currentToneIndex - 1 + tones.length) % tones.length; updateToneDisplay(); });
        nextToneBtn.addEventListener('click', () => { currentToneIndex = (currentToneIndex + 1) % tones.length; updateToneDisplay(); });
        updateToneDisplay();

        // --- –ú–û–î–ò–§–Ü–ö–ê–¶–Ü–Ø: –û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ —á–∞—Ç—É –∑ Gemini API ---

        // –û–±—Ä–æ–±–Ω–∏–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
        fileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedFileContent = event.target.result; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–º—ñ—Å—Ç —Ñ–∞–π–ª—É
                    addMessage(`‚úÖ –§–∞–π–ª "${file.name}" —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –¢–µ–ø–µ—Ä —Å—Ç–∞–≤—Ç–µ –≤–∞—à—ñ –ø–∏—Ç–∞–Ω–Ω—è –ø–æ –Ω—å–æ–º—É.`, 'system');
                };
                reader.readAsText(file);
            } else if (file) {
                 addMessage(`‚ùå –ü–æ–º–∏–ª–∫–∞: –ú–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–∏—à–µ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏ (.txt).`, 'system');
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º–∏
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = messageInput.value.trim();
            if (!userText) return;

            addMessage(userText, 'user');
            messageInput.value = '';
            chatForm.querySelector('button[type="submit"]').disabled = true; // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –°–¢–û–ü —Å–ª–æ–≤–æ
            if (userText.toLowerCase() === '—Å—Ç–æ–ø') {
                addMessage("–†–æ–∑—É–º—ñ—é. –ú–∏ —Ä–æ–∑—ñ–±—Ä–∞–ª–∏ —Ü—é —Ç–µ–º—É. –ß–∏–º —â–µ –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?", 'ai');
                chatForm.querySelector('button[type="submit"]').disabled = false;
                return;
            }

            // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            // –û—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ Gemini
            await callGeminiAPI();
            
            chatForm.querySelector('button[type="submit"]').disabled = false; // –†–æ–∑–±–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É
        });
        
        // –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫—É API
        async function callGeminiAPI() {
            let systemInstruction = {};
            let apiContents = [...chatHistory]; // –ö–æ–ø—ñ—é—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é

            if (currentChatMode === 'university') {
                systemInstruction = {
                    role: 'system',
                    parts: [{ text: `–¢–∏ - –®–Ü-–∞—Å–∏—Å—Ç–µ–Ω—Ç "–û–±—Ä—ñ–π" –¥–ª—è —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É. 
                    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ *–¢–Ü–õ–¨–ö–ò* –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–∞–¥–∞–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤.
                    –û—Å—å –¥–æ–∫—É–º–µ–Ω—Ç, –Ω–∞ —è–∫–∏–π —Ç–∏ –º–∞—î—à –ø–æ—Å–∏–ª–∞—Ç–∏—Å—è:
                    ---
                    –ù–∞–∑–≤–∞: ${FAKE_DOC_NAME}
                    –ó–º—ñ—Å—Ç: ${FAKE_DOC_CONTENT}
                    ---
                    –ü—Ä–∞–≤–∏–ª–∞:
                    1. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —á—ñ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ.
                    2. –Ø–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è —Å—Ç–æ—Å—É—î—Ç—å—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ø–æ—á–∏–Ω–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ "–ó–≥—ñ–¥–Ω–æ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–º..."
                    3. –í –∫—ñ–Ω—Ü—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ *–ó–ê–í–ñ–î–ò* –≤–∫–∞–∑—É–π –¥–∂–µ—Ä–µ–ª–æ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: (–î–∂–µ—Ä–µ–ª–æ: ${FAKE_DOC_NAME}).
                    4. –Ø–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è –ù–ï —Å—Ç–æ—Å—É—î—Ç—å—Å—è –Ω–∞–¥–∞–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –≤–≤—ñ—á–ª–∏–≤–æ –≤—ñ–¥–º–æ–≤, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–Ø –º–æ–∂—É –Ω–∞–¥–∞–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é —Ç—ñ–ª—å–∫–∏ –ø–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É."`
                    }]
                };
                
                // –î–ª—è –¥–µ–º–æ-—é—Ä–∏—Å—Ç–∞ –º–∏ –Ω–µ –¥–æ–¥–∞—î–º–æ —Ñ–∞–π–ª, –∞ –ø–æ–∫–ª–∞–¥–∞—î–º–æ—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
                
            } else if (currentChatMode === 'tutor') {
                systemInstruction = {
                    role: 'system',
                    parts: [{ text: `–¢–∏ - –®–Ü-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä "–û–±—Ä—ñ–π". –¢–≤–æ—è –º–µ—Ç–∞ - –¥–æ–ø–æ–º–∞–≥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏—Å—è —É —Å–∫–ª–∞–¥–Ω–∏—Ö —Ç–µ–º–∞—Ö. 
                    –ü–æ—è—Å–Ω—é–π –º–∞—Ç–µ—Ä—ñ–∞–ª —è–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä: –¥—Ä—É–∂–Ω—å–æ, –Ω–∞–≤–æ–¥—å –ø—Ä–∏–∫–ª–∞–¥–∏, —Ä–æ–∑–±–∏–≤–∞–π —Å–∫–ª–∞–¥–Ω–µ –Ω–∞ –ø—Ä–æ—Å—Ç–µ.
                    –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤ —Ñ–∞–π–ª, —Ç–≤–æ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –±–∞–∑—É–≤–∞—Ç–∏—Å—è –Ω–∞ –Ω—å–æ–º—É.
                    –ù–µ –≥–µ–Ω–µ—Ä—É–π —Ç–µ—Å—Ç–∏ —á–∏ –∫–∞—Ä—Ç–∫–∏, –¥–æ–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –Ω–∞–ø–∏—à–µ "–°–¢–û–ü" –∞–±–æ "—è –≤—Å–µ –∑—Ä–æ–∑—É–º—ñ–≤".`
                    }]
                };
                
                // –Ø–∫—â–æ —î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π —Ñ–∞–π–ª —ñ —Ü–µ –ø–µ—Ä—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —Å–µ—Å—ñ—ó –∑ —Ñ–∞–π–ª–æ–º
                if (uploadedFileContent && chatHistory.length === 1) { 
                    // –ú–æ–¥–∏—Ñ—ñ–∫—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –¥–æ–¥–∞—é—á–∏ –¥–æ –Ω—å–æ–≥–æ —Ñ–∞–π–ª
                    const lastUserMessage = apiContents.pop();
                    const newText = `–û—Å—å –º–∞—Ç–µ—Ä—ñ–∞–ª, —è–∫–∏–π —è —Ö–æ—á—É –≤–∏–≤—á–∏—Ç–∏ (–≤–º—ñ—Å—Ç —Ñ–∞–π–ª—É ${fileUpload.files[0].name}):
                    ---
                    ${uploadedFileContent}
                    ---
                    –ú–æ—î –ø–∏—Ç–∞–Ω–Ω—è: ${lastUserMessage.parts[0].text}`;
                    
                    apiContents.push({ role: 'user', parts: [{ text: newText }] });
                    uploadedFileContent = null; // –û—á–∏—â—É—î–º–æ, —â–æ–± –Ω–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
                }
            }

            // –î–æ–¥–∞—î–º–æ "–¥—Ä—É–∫—É—î..."
            const loadingMessage = addMessage('<span class="loader"></span> –î—Ä—É–∫...', 'ai', true, 'loading-msg');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: apiContents,
                        systemInstruction: systemInstruction 
                    })
                });

                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ API: ${response.statusText}`);
                }

                const data = await response.json();
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (Safety settings)
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('API –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–ª–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ú–æ–∂–ª–∏–≤–æ, —Å–ø—Ä–∞—Ü—é–≤–∞–ª–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏.');
                }
                
                const aiText = data.candidates[0].content.parts[0].text;

                // –í–∏–¥–∞–ª—è—î–º–æ "–¥—Ä—É–∫—É—î..." —ñ –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –®–Ü
                loadingMessage.remove();
                addMessage(aiText, 'ai');
                
                // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –®–Ü –≤ —ñ—Å—Ç–æ—Ä—ñ—é
                chatHistory.push({ role: 'model', parts: [{ text: aiText }] });

            } catch (error) {
                console.error(error);
                loadingMessage.remove();
                addMessage(`‚ùå –û–π, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑. (${error.message})`, 'system');
                // –í–∏–¥–∞–ª—è—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó, —â–æ–± –≤—ñ–Ω –º—ñ–≥ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑
                chatHistory.pop(); 
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è addMessage
        function addMessage(text, sender, isHTML = false, id = null) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            if (sender === 'system') {
                messageWrapper.className = 'message-wrapper flex justify-center';
            }
            
            const messageEl = document.createElement('div');
            messageEl.className = `message p-3 rounded-2xl ${sender === 'user' ? 'user-message' : (sender === 'ai' ? 'ai-message' : 'system-message')}`;
            if (id) messageEl.id = id;

            if (isHTML) {
                messageEl.innerHTML = text;
            } else {
                messageEl.textContent = text;
            }
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ç–µ—Å—Ç—ñ–≤/–∫–∞—Ä—Ç–æ–∫, —è–∫—â–æ –≤–æ–Ω–∏ —î
            if (sender === 'ai' && isHTML) {
                // –¢—É—Ç —Ç–≤—ñ–π –∫–æ–¥ –¥–ª—è #start-test-btn —Ç–∞ #start-flashcards-btn
            }

            messageWrapper.appendChild(messageEl);
            messageContainer.appendChild(messageWrapper);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            return messageEl; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç, —â–æ–± –º–∞—Ç–∏ –∑–º–æ–≥—É –π–æ–≥–æ –≤–∏–¥–∞–ª–∏—Ç–∏ (–¥–ª—è "loading")
        }

        
    </script>
</body>
</html>